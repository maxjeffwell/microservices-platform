# Vertex Platform - Nginx Configuration
# Copy to: /etc/nginx/sites-available/vertex-platform.conf
# Enable with: sudo ln -s /etc/nginx/sites-available/vertex-platform.conf /etc/nginx/sites-enabled/
# Test with: sudo nginx -t
# Reload with: sudo systemctl reload nginx

upstream auth_service {
    server 127.0.0.1:3001;
    keepalive 32;
}

upstream analytics_service {
    server 127.0.0.1:3005;
    keepalive 32;
}

server {
    listen 80;
    server_name 86.48.29.183;  # Replace with your domain when ready

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Health check
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Root - API info
    location = / {
        default_type application/json;
        return 200 '{
    "name": "Vertex Platform API",
    "version": "1.0.0",
    "endpoints": {
        "auth": "/api/auth",
        "analytics": "/api/analytics"
    },
    "health": "/health"
}';
    }

    # Auth Service
    location /api/auth/ {
        rewrite ^/api/auth/(.*) /$1 break;
        proxy_pass http://auth_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Analytics Service
    location /api/analytics/ {
        rewrite ^/api/analytics/(.*) /$1 break;
        proxy_pass http://analytics_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 404 for everything else
    location / {
        return 404 '{"error": "Not Found"}';
        default_type application/json;
    }

    # Logging
    access_log /var/log/nginx/vertex-platform.access.log;
    error_log /var/log/nginx/vertex-platform.error.log;
}
